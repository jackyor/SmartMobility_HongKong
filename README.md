# matsim_HongKong

## scenario
The scenario in this research is that daily commuting trips traveling by taxi are replaced by ridepooling exclusively. Therefore, the simulation focuses on those trips only and ignores others to reduce computational costs. The MATsim simulation requires an input of the road network, agents' daily activities plan, vehicles, and a general configuration file. The road network in Hong Kong is based on OpenStreetMap. The agent's daily activities plan is based on a synthesis population created from the Travel Characteristics Survey 2011. Each agent in the population is assigned a home coordinate and work coordinate. To increase the representativeness of the agents' plans, the simulation is only focusing on commuting trips in the morning and in the evening traveling by taxi. As for vehicles, which is the independent variable in this simulation, will be mentioned in the next subchapter. In terms of MATsim configuration, the travel behaviors of agents are fixed as there is no rerouting and the mode choice for agents is restricted to ridepooling and walking only. The maximum waiting time is ten minutes and any request exceeds it is rejected by the ridepooling system. The ridepooling system operates in door-to-door. As simulations are run on the Amazon Elastic Compute Cloud, the configuration of the computing system is shown Appendix I.

In this base case scenario, we assume that passengers exclusively choose private rides as their mode of travel. The results generated from this scenario will serve as a benchmark for comparison against scenarios involving ridepooling services. In the stop-based scenario, ridepooling route based on stops. In this scenario, passengers are picked up and dropped off at predefined locations as virtual stops. These stops are defined as the taxi stand points extracted from OpenStreeMap and there are total 331 predefined stops in Hong Kong. In the door-to-door scenario, ridepooling route based on passengers requests. Passengers are picked up and dropped off at requested locations that set by passgeners.


## run
- linux config
- how to run
- runtime

## output
The data for analysising performance of drt are in the folder of result, including customer stats, detailed vehicle stats and vehicle stats. The findings are in the findings folder that includes figures of analysised output stats generated from the model. The general performance of ridepooling vs. exclusive ride (e.g. taxi) in terms of VKT is showed below. <br/>
<img width="661" alt="Screenshot 2023-12-16 at 6 45 03â€¯PM" src="https://github.com/jackyor/matsim_HongKong/assets/87265896/67b2097d-eb11-4c71-a389-8249dd0661e3">


## Input Data Preperation
### Network
First, download map file of Hong Kong from [OpenStreetMap](https://www.openstreetmap.org/).
Then, follow the intrustion in [pt2matsim](https://github.com/matsim-org/pt2matsim) to create a network. 
If public transport is needed to be included in the model, it also can use to create multimodel network and transit schedule that used for simlulating public transport in MATSim.

### Plan
The MATSim plan file represents a synthesis population generated from the data of the [Travel Characteristics Survey 2011](https://www.td.gov.hk/en/publications_and_press_releases/publications/free_publications/travel_characteristics_survey_2011_final_report/index.html) and [census 2021]([https://www.census2021.gov.hk/en/index.html](https://www.census2021.gov.hk/en/index.html)) .
Since the model did not access to the detailed data of both sources, the synthesis population is generated from general parameter in tcs2011 and census 2021. 
The synthesis population is focused on the daily commuting work trips travelling by taxi only and generated by the following steps. 

1) Get inner and inter commuting data
First, get the [Statistics by District Council Constituency Area](https://www.census2021.gov.hk/doc/DCCA_21C.xlsx) from census 2021. It lists **Working population by place of work** including Work in the same district; Work in another district on Hong Kong Island; Work in another district in Kowloon; Work in another district in new towns; and Work in another district in other areas in the New Territories. These stats are grouped by District Council Constituency Area.

2) Mark buildings to their District Council and District Council Constituency Areas
Get the buildings of hong kong from [Lands Department](https://data.gov.hk/en-data/dataset/hk-landsd-openmap-b50k-topographic-map-of-hong-kong).
Then, use gis to mark buildings to their District Council and District Council Constituency Areas. It is used for the random selection of home and work coordinates in the next step.
To be more precise, you can seperate residential buildings and others for the selection of the coordinates of home and work.

3) Generate inter and inner district commuting work trips
Create a inner.csv and a inter.csv from the communting data, similar to the csv files in the "forplan" folder with the use of [Table A.2 Daily Person Trip Productions and Attractions by Broad District and Trip Purpose](https://www.td.gov.hk/filemanager/en/content_4652/tcs2011app_eng.pdf) by tcs 2011.

Then, set the home end time, work end time. It was set as the same home end time and work end time for every plan. I redistributed them according to the Figure 3.3 Hourly Profiles of Mechanised Trips Travel Characteristics Survey 2011 final report by python script uploaded as **main.py**. 

<img width="682" alt="Figure 3.3 Hourly Profiles of Mechanised Trips in Travel Characteristics Survey 2011 final report" src="https://github.com/jackyor/matsim_HongKong/assets/87265896/22a60ac0-78b1-46a0-98d5-9fed0842a077">

Next, the inter and inner district commuting work trips were generated. As according to Table A.3 Number of Daily Boardings by Transport Mode and Trip Purpose in tcs 2011, for home based work trips, trips travelling by taxi was about 3.72% (230,000/6,179,000) of all home based work trips. Therefore, only 3.72% of home based work trips were generated. The coordinates of home were randomly selected in the pool of buildings marked with the designated District Council Constituency Areas in the inner or inter csv file. The coordinates of work were randomly selected in the pool of buildings marked with the designated 
District Council or the number representing different New Towns. In this model, all plans have the same activity structure as home - work - home.


### Drt Vehicle
Use **CreateFleetVehicles.java** to create vehicle files with designated number of vehicles and operation hour. Drt vehicles in this model operated in 24 hours.
### Drt Stops
The virtual stops representing stops for drt vehicles operating in stop-based ridepooling is in the **drtStops.xml **. Stops were extracted from the OpenStreetMap as points of Taxi Stand in Hong Kong.

## MATSim
More details about MATSim in [MASTim.org](https://www.matsim.org/). <br />
The config file are in the scenarios/opt follder as ***.config.xml**. door2s refer to door-to-door based ridepooling with a capacity of 2 and stop2s refer to stop-based ridepooling with a capacity of 2. There were 16 iteration in total.
DRT, DVRP, drt-extension were the extension used for stimulating ridepooling in this model (can be found in pom.xml), those can be found in https://github.com/matsim-org/matsim-libs/tree/master/contribs. [FISS](https://github.com/matsim-org/matsim-libs/tree/master/contribs/drt-extensions/src/main/java/org/matsim/contrib/drt/extension/fiss) (Flow-inflated Selective Sampling) was used for havling the computation time through the drt-extension.

simwrapper was the extension used for anlysising output in dashboards, more details in https://simwrapper.github.io/. 
[optDRT](https://github.com/matsim-vsp/opt-drt) was also used in the model but not used as an extension. You can find optDRT java classes in this repository. It was used for increasing the fleet numebr of drt vehicles if the 90th percentile of waiting time is above 360 seconds or 6 minutes after a iteration.
